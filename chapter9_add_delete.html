<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Chapter 9</title>
		<!-- https://github.com/scotthmurray/d3-book -->
		<script 
			type="text/javascript" src="https://d3js.org/d3.v6.js">
		</script>
	</head>
	<body>
		<h1>My new updateable chart!</h1>
		<p id="update">Click here to update!</p>
		<svg id="uchart"></svg>
		<script>
			var dataset =[ 5,10,13,19,21,25,22,18,15,13,
						  11,12,15,20,18,17,16,18,23,25];

			var width=627;
			var height=300;
			var border = {left:30,right:30,top:30,bottom:30};
			var barpadding = 2

			document.getElementById("uchart").setAttribute("height",height);
			document.getElementById("uchart").setAttribute("width",width);
			
			var yScale = d3.scaleLinear()
				.domain([0,d3.max(dataset,d=>d)])
				.range([0,height]);
			
			var rgbScale = d3.scaleLinear()
				.domain([d3.min(dataset,d=>d),d3.max(dataset,d=>d)])
				.range([0,255]);

			var xScale = d3.scaleBand()
				.domain(d3.range(dataset.length))
				.rangeRound([0,width])
				//.round(true)
				.paddingInner(0.05);

			d3.select("#uchart")
				.selectAll("rect")
				.data(dataset)
				.enter()
				.append("rect")
				//.attr("x",(d,i)=>i*(width/dataset.length))
				.attr("x",(d,i)=>xScale(i))
				.attr("y",d=>height-yScale(d))
				//.attr("width",width/dataset.length-barpadding)
				.attr("width",xScale.bandwidth())
				.attr("height",d=>yScale(d))
				.attr("fill",d=>"rgb(0,0,"+Math.round(rgbScale(d))+")");
				//.attr("fill","blue");

			d3.select("#uchart")
				.selectAll("text")
				.data(dataset)
				.enter()
				.append("text")
				//.attr("x",(d,i)=>i*(width/dataset.length)+(width/dataset.length-barpadding)/2)
				.attr("x",(d,i)=>xScale(i)+xScale.bandwidth()/2)
				.attr("y",d=>height-yScale(d)+(d==1?-5:15))
				.text(d=>d)
				.attr("font-size","11px")
				.attr("font-family","sans-serif")
				.attr("fill",d=>(d==1?"black":"white"))
				.attr("text-anchor","middle");
			
			d3.select("#update")
				.on("click",function(){
					//new random set
					// var numValues = dataset.length;
					// for(var i=0;i<numValues;i++){
					// 	dataset[i]=Math.floor(Math.random()*40)+1;
					// }
					
					//just add a new element
					dataset.push(Math.floor(Math.random()*25)+1);
					
					xScale.domain(d3.range(dataset.length))
					
					//recalc scales
					yScale.domain([0,d3.max(dataset,d=>d)]);
					rgbScale.domain([d3.min(dataset,d=>d),d3.max(dataset,d=>d)]);

					//redraw bars
					d3.select("#uchart")
						.selectAll("rect")
						.data(dataset)
						.enter()
						.transition()
						.delay((d,i)=>i*100)
						.duration(500)
						//.ease(d3.easeBounceOut)
						.attr("y",d=>height-yScale(d))
						.attr("height",d=>yScale(d))
						.attr("fill",d=>"rgb(0,0,"+Math.round(rgbScale(d))+")");

					//redraw labels
					d3.select("#uchart")
						.selectAll("text")
						.data(dataset)
						.transition()
						.delay((d,i)=>i*100)
						.duration(500)
						//.ease(d3.easeBounceOut)
						.attr("y",d=>height-yScale(d)+(d==1?-5:15))
						.attr("fill",d=>(d==1?"black":"white"))
						.text(d=>d);
					})

		</script>
	</body>
</html>
